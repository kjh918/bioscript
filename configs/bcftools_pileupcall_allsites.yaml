# =========================================================
# bcftools Pileup + Call + Annotate Pipeline
#  1. mpileup: 특정 Sites에 대해 BAM으로부터 Pileup 생성
#  2. call: 변이 호출 (Consensus/Variant calling)
#  3. annotate: 인구 집단 빈도(AF) 및 외부 DB 정보 주입
# =========================================================
tool:
  name: bcftools
  version: "1.23"
  profile: "QC_PileupCall_Annotation"

io:
  inputs:
    SeqID:           { required: true, help: "Sequence identifier for the sample" }
    Chromosome:      { required: true, help: "Target chromosome or region" }
    BamDir:          { required: true, help: "Directory containing the input BAM file" }
    ResultDir:       { required: true, help: "Output directory for VCF results" }
    
    # Reference & Annotation DB
    ReferenceFasta:  { required: true, help: "Path to reference genome FASTA" }
    SitesVcfGz:      { required: true, help: "VCF file containing specific sites to genotype" }
    PopAfAnnotVcf:   { required: true, help: "VCF/Tabix file for population AF annotation" }
    PopAfHeaderHdr:  { required: true, help: "Header file describing the annotation columns" }

  outputs:
    # Suffix와 Chromosome을 조합하여 명확한 결과 파일명 생성
    raw_vcf:
      default: "[ResultDir]/[SeqID].[Chromosome].[InputSuffix].raw.vcf.gz"
      help: "Raw VCF file after pileup and calling"
    ann_vcf:
      default: "[ResultDir]/[SeqID].[Chromosome].[InputSuffix].ann.vcf.gz"
      help: "Annotated VCF file with population AF"

params:
  # --- [Suffix 제어] ---
  InputSuffix: { type: str, default: "analysisReady", help: "Suffix of input BAM (e.g., analysisReady, recal)" }

  # --- [Binaries & Resources] ---
  bcftools_bin: { type: str, default: "/storage/home/jhkim/Apps/bcftools/bcftools", help: "Path to bcftools binary" }
  Threads:      { type: int, default: 4, help: "Number of threads for compression/processing" }
  MinBQ:        { type: int, default: 20, help: "Minimum base quality for mpileup" }
  MinMQ:        { type: int, default: 30, help: "Minimum mapping quality for mpileup" }
  
  # --- [Annotation Settings] ---
  AnnotationQuery:
    { type: str, default: "CHROM,POS,REF,ALT,INFO/KOVA_AF,INFO/KOVA_AN,INFO/GNOMAD_AF,INFO/GNOMAD_AN", help: "Columns to extract from annotation VCF" }

cmd_line: >
  [bcftools_bin] mpileup
  -f [ReferenceFasta]
  -T [SitesVcfGz]
  -r [Chromosome]
  -q [MinMQ]
  -Q [MinBQ]
  -a FORMAT/AD,FORMAT/DP
  -Ou
  --threads [Threads]
  [BamDir]/[SeqID].[InputSuffix].bam
  |
  [bcftools_bin] call
  -Am
  -Oz -o [raw_vcf]
  --threads [Threads]
  &&
  [bcftools_bin] index -f [raw_vcf] --threads [Threads]
  &&
  [bcftools_bin] annotate
  -a [PopAfAnnotVcf]
  -c [AnnotationQuery]
  -h [PopAfHeaderHdr]
  -Oz -o [ann_vcf]
  [raw_vcf]
  --threads [Threads]
  &&
  [bcftools_bin] index -f [ann_vcf] --threads [Threads]